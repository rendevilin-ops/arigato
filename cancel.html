<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Annulation de réservation</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h2>Annulation de réservation</h2>

<p id="message">Chargement des informations de réservation...</p>

<div id="reservationCard" class="card" style="display:none;"></div>

  <label>
Si vous le souhaitez, vous pouvez nous indiquer la raison de votre annulation. Cela nous aidera à améliorer notre service.<br>
<textarea id="comment" rows="4" style="width:100%;"></textarea>
</label>
  
<button id="cancelBtn" style="display:none;">
  Annuler la réservation
</button>

<script>
const params = new URLSearchParams(window.location.search);
const id = params.get("id");

const messageEl = document.getElementById("message");
const btn = document.getElementById("cancelBtn");
const card = document.getElementById("reservationCard");

let reservationData = null;

async function loadReservation() {
  if (!id) {
    messageEl.innerText = "Réservation introuvable.";
    return;
  }

  try {
    const res = await fetch(
      `https://arigato-admin.vercel.app/api/reservations/get?id=${id}`
    );

    const data = await res.json();

    if (!res.ok || !data.reservation) {
      messageEl.innerText = "Réservation introuvable.";
      return;
    }

    reservationData = data.reservation;

    card.innerHTML = `
      <strong>Name:</strong> ${reservationData.FirstName} ${reservationData.LastName}<br>
      <strong>Date:</strong> ${reservationData.date}<br>
      <strong>Service:</strong> ${reservationData.service}<br>
      <strong>Arrival:</strong> ${reservationData.ArrivalTime}<br>
      <strong>Pax:</strong> ${reservationData.Pax}
    `;

    card.style.display = "block";

    if (reservationData.Status === "cancelled") {
      messageEl.innerText = "Cette réservation a déjà été annulée.";
      btn.style.display = "none";
    } else {
      messageEl.innerText = "Souhaitez-vous annuler cette réservation ?";
      btn.style.display = "inline-block";
    }

  } catch (err) {
    console.error(err);
    messageEl.innerText = "Une erreur est survenue. Veuillez réessayer.";
  }
}

btn.addEventListener("click", async () => {
  if (!reservationData) return;

  btn.disabled = true;
  messageEl.innerText = "Annulation en cours...";

  try {
    const comment = document.getElementById("comment").value;
    
    const updatedReservation = {
      ...reservationData,
      Status: "cancelled",
      Commentaire: comment || reservationData.Commentaire,
      UpdateAt: new Date().toISOString()
    };

    const res = await fetch(
      "https://arigato-admin.vercel.app/api/reservations/update-status",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          type: "reservation_update",
          reservation: updatedReservation
        })
      }
    );

    const result = await res.json();

    if (result.ok) {
      messageEl.innerText =
        <strong>"Votre réservation a bien été annulée. Nous espérons vous accueillir prochainement chez Arigato.</strong>";
      btn.style.display = "none";
    } else {
      messageEl.innerText = "Une erreur est survenue. Veuillez réessayer.";
      btn.disabled = false;
    }

  } catch (err) {
    messageEl.innerText = "Une erreur de connexion est survenue. Veuillez réessayer.";
    btn.disabled = false;
  }
});

loadReservation();
</script>

</body>
</html>
